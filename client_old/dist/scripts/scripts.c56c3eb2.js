(function(){"use strict";angular.module("sseAppApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ng-token-auth","sseAppApp.interceptors","sseAppApp.directives","sseAppApp.services","sseAppApp.controllers","sseAppApp.resources"]).config(["$authProvider","$compileProvider",function(a,b){return b.aHrefSanitizationWhitelist(/^\s*(|blob|):/),a.configure({apiUrl:"/api"})}]).config(["$routeProvider",function(a){return a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{auth:function(a){return console.log("Checking authorization for / ..."),a.validateUser().then(function(a){return console.log(JSON.stringify(a))})}}}).when("/login",{templateUrl:"views/login.html",controller:"LoginController as ctrl"}).otherwise({redirectTo:"/login"})}]).run(["$rootScope","$location",function(a,b){return a.$on("event:unauthorized",function(){return b.path("/login")})}])}).call(this),function(){"use strict";angular.module("sseAppApp.interceptors",[]).factory("AuthInterceptor",["$q","$rootScope",function(a,b){return{responseError:function(c){return 401===c.status&&b.$broadcast("event:unauthorized"),a.reject(c)}}}]).config(["$httpProvider",function(a){return a.interceptors.push("AuthInterceptor")}])}.call(this),function(){"use strict";angular.module("sseAppApp.directives",[])}.call(this),function(){"use strict";angular.module("sseAppApp.directives").directive("userPanel",function(){return{templateUrl:"views/user_panel.html",controller:["$scope","UsersService",function(a,b){return console.log("[UserPanelDirective] Initialized"),a.$on("user:set",function(b,c){return a.currentUser=c}),a.$on("user:unset",function(){return a.currentUser=null}),b.currentUser().then(function(b){return a.currentUser=b}),a.logout=function(){return b.logout().then(function(){return a.currentUser=null})}}]}})}.call(this),function(){"use strict";angular.module("sseAppApp.directives").directive("onScreenKeyboard",function(){return{restrict:"A",require:"?ngModel",scope:{layout:"="},link:function(a,b,c,d){var e;if(d)return console.log("[onScreenKeyboard] starting with layout "+c.layout+" ..."),e="qwerty",c.layout&&(e=c.layout),$(b).keyboard({autoAccept:!0,stickyShift:!0,usePreview:!1,layout:e})}}})}.call(this),function(){"user strict";angular.module("sseAppApp.resources",["rails"])}.call(this),function(){"use strict";var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};angular.module("sseAppApp.resources").factory("Post",["$http","RailsResource",function(a,c){var d;return d=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.configure({url:"/api/posts",name:"post"}),c}(c)}])}.call(this),function(){"use strict";var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};angular.module("sseAppApp.resources").factory("User",["$http","$q","RailsResource",function(a,c,d){var e;return e=function(a){function d(){return d.__super__.constructor.apply(this,arguments)}return b(d,a),d.configure({url:"/api/users",name:"user"}),d.findById=function(a){var b;return b=c.defer(),this.query({id:a}).then(function(){return function(a){var c;return a.length>0?(c=a[0],b.resolve(c)):b.reject(null)}}(this)),b.promise},d}(d)}])}.call(this),function(){"use strict";angular.module("sseAppApp.services",[])}.call(this),function(){"use strict";var a;angular.module("sseAppApp.services").service("PostsService",a=function(){function a(a,b,c,d){this.$q=a,this.$http=b,this.$window=c,this.Post=d,console.log("[PostsService] initializing ...")}return a.prototype.all=function(){var a;return a=this.$q.defer(),this.Post.query().then(function(b){return a.resolve(b)}),a.promise},a.prototype.save=function(a){var b;return b=this.$q.defer(),a=new this.Post({message:a.message,user_id:a.user_id}).create().then(function(a){return b.resolve(a)}),b.promise},a.prototype.getPdf=function(a){var b;return b=this.$q.defer(),this.Post.$get("/api/pdf",{path:"./public/"+a}).then(function(a){return b.resolve(a)}),b.promise},a}())}.call(this),function(){"use strict";var a;angular.module("sseAppApp.services").service("UsersService",a=function(){function a(a,b,c,d,e){this.$q=a,this.$cookieStore=b,this.$rootScope=c,this.$auth=d,this.User=e,console.log("[UsersService] initializing ..."),this.$rootScope.$on("event:unauthorized",function(a){return function(){return a.logout()}}(this))}return a.prototype._user=null,a.prototype.setCurrentUser=function(a){return a=a.id,this.$cookieStore.put("user",a),console.log("[setCurrentUser] auth_headers: "+JSON.stringify(this.$cookieStore.get("auth_headers"))),this.User.findById(a).then(function(a){return function(b){return a._user=b,a._user.auth_header=a.$cookieStore.get("auth_headers"),a.$rootScope.$broadcast("user:set",a._user)}}(this))},a.prototype.unsetCurrentUser=function(){return console.log("[unsetCurrentUser] Clearing user and cookies!"),this._user=null,this.$cookieStore.remove("user"),this.$cookieStore.remove("auth_headers"),this.$rootScope.$broadcast("user:unset")},a.prototype.currentUser=function(){var a;return a=this.$q.defer(),this.$auth.validateUser().then(function(b){return function(){return b.$cookieStore.get("user")?(b.setCurrentUser(b.$cookieStore.get("user")),a.resolve(b._user)):a.resolve(null)}}(this))["catch"](function(a){return function(b){return console.log("No valid authenticated user: "+JSON.stringify(b)),a.unsetCurrentUser()}}(this)),a.promise},a.prototype.signup=function(a){var b;return b=this.$q.defer(),this.$auth.submitRegistration(a).then(function(){return function(a){return b.resolve(a.data.data)}}(this))["catch"](function(a){return function(c){return console.log("Signup failed: "+JSON.stringify(c)),a.$auth.signOut(),a.unsetCurrentUser(),b.reject(c.data.errors)}}(this)),b.promise},a.prototype.login=function(a){var b;return b=this.$q.defer(),this.$auth.submitLogin(a).then(function(a){return function(c){return a.setCurrentUser(c),b.resolve(a._user)}}(this)),b.promise},a.prototype.logout=function(){var a;return a=this.$q.defer(),this.$auth.signOut(),this.unsetCurrentUser(),a.resolve(),a.promise},a}())}.call(this),function(){"use strict";angular.module("sseAppApp.controllers",[])}.call(this),function(){"use strict";angular.module("sseAppApp").controller("MainCtrl",["$scope","$window","$sce","PostsService","UsersService",function(a,b,c,d,e){var f;return a.posts=[],a.post={},f=new EventSource("/api/stream"),f.addEventListener("open",function(){return function(){return a.$apply(function(){return console.log("Stream OPENED!")})}}(this),!1),f.addEventListener("heartbeat",function(){return function(){return a.$apply(function(){return console.log("*** heartbeat ***")})}}(this),!1),f.addEventListener("posts.create",function(){return function(b){return a.$apply(console.log("Stream message:"+JSON.stringify(b.data)),a.posts.unshift(JSON.parse(b.data)))}}(this),!1),f.addEventListener("posts.flush",function(){return function(b){return a.$apply(console.log("Posts flushed!"+JSON.stringify(b.data)),a.refreshPosts())}}(this),!1),f.addEventListener("posts.pdf",function(){return function(e){return a.$apply(console.log("PDF READY!"+JSON.stringify(e.data)),d.getPdf(e.data).then(function(d){var e,f;return e=new Blob([d],{type:"application/pdf"}),f=(b.URL||window.webkitURL).createObjectURL(e),a.pdf_path=c.trustAsResourceUrl(f)}))}}(this),!1),a.refreshPosts=function(){return d.all().then(function(){return function(b){return console.log("Requesting all posts ..."),a.posts=b}}(this))},a.postMessage=function(){return e.currentUser().then(function(b){return a.post.user_id=b.id,d.save(a.post)})},a.refreshPosts()}])}.call(this),function(){"use strict";var a;angular.module("sseAppApp.controllers").controller("LoginController",a=function(){function a(a,b){this.$location=a,this.UsersService=b,console.log("[LoginController] initializing ..."),this.UsersService.currentUser().then(function(a){return function(b){return a.user=b}}(this))}return a.prototype.signup={},a.prototype.login={},a.prototype.user=null,a.prototype.submitSignup=function(){return this.UsersService.signup(this.signup).then(function(a){return function(b){return console.log("[LoginController] registered as: "+JSON.stringify(b)),a.signup.success=!0,a.signup.errors=void 0}}(this))["catch"](function(a){return function(b){return console.log("[LoginController] Signup failed: "+JSON.stringify(b)),a.signup.success=!1,a.signup.errors=b}}(this))},a.prototype.submitLogin=function(){return this.UsersService.login(this.login).then(function(a){return function(b){return console.log("[LoginController] logged in as: "+JSON.stringify(b)),a.user=b,a.$location.path("/")}}(this))},a}())}.call(this);